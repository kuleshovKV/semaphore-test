---
- name: "Complete Cloudflare Setup: Add Domains & Create DNS Records"
  hosts: all
  gather_facts: yes
  
  tasks:
    - name: "Clone repository with domains and subdomains"
      shell: |
        rm -rf /tmp/casino-config
        git clone https://github.com/YOUR_USERNAME/YOUR_REPO.git /tmp/casino-config
        cd /tmp/casino-config
        ls -la
      register: git_clone

    - name: "Show cloned files"
      debug:
        msg: "{{ git_clone.stdout_lines }}"

    - name: "Find domains.csv file"
      shell: find /tmp/casino-config -name "domains.csv" -type f
      register: domains_path

    - name: "Find subdomains.csv file"
      shell: find /tmp/casino-config -name "subdomains.csv" -type f
      register: subdomains_path

    - name: "Show file paths"
      debug:
        msg: |
          Domains: {{ domains_path.stdout }}
          Subdomains: {{ subdomains_path.stdout }}

    - name: "Copy domains to /tmp"
      shell: cp {{ domains_path.stdout }} /tmp/domains.csv
      when: domains_path.stdout != ""

    - name: "Copy subdomains to /tmp"
      shell: cp {{ subdomains_path.stdout }} /tmp/subdomains.csv
      when: subdomains_path.stdout != ""

    - name: "Read domains"
      shell: cat /tmp/domains.csv
      register: domains_content

    - name: "Read subdomains"
      shell: cat /tmp/subdomains.csv
      register: subdomains_content

    - name: "Show loaded data"
      debug:
        msg: |
          ðŸ“‹ DOMAINS:
          {{ domains_content.stdout }}
          
          ðŸ“‹ SUBDOMAINS:
          {{ subdomains_content.stdout }}

    - name: "Add domains to Cloudflare"
      shell: |
        for domain in $(cat /tmp/domains.csv); do
          [ -z "$domain" ] && continue
          
          echo "Checking if ${domain} exists..."
          
          check=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=${domain}" \
            -H "X-Auth-Email: {{ cf_email }}" \
            -H "X-Auth-Key: {{ cf_api_key }}" \
            -H "Content-Type: application/json")
          
          exists=$(echo "$check" | python3 -c "import sys, json; d=json.load(sys.stdin); print('YES' if d.get('result') and len(d['result']) > 0 else 'NO')")
          
          if [ "$exists" = "NO" ]; then
            echo "Adding ${domain}..."
            
            response=$(curl -s -X POST "https://api.cloudflare.com/client/v4/zones" \
              -H "X-Auth-Email: {{ cf_email }}" \
              -H "X-Auth-Key: {{ cf_api_key }}" \
              -H "Content-Type: application/json" \
              -d "{\"name\":\"${domain}\",\"jump_start\":true}")
            
            success=$(echo "$response" | python3 -c "import sys, json; d=json.load(sys.stdin); print('SUCCESS' if d.get('success') else 'FAILED')" 2>/dev/null || echo "FAILED")
            
            if [ "$success" = "SUCCESS" ]; then
              echo "âœ… ${domain} added"
            else
              echo "âŒ ${domain} failed"
            fi
            
            sleep 3
          else
            echo "âœ… ${domain} exists"
          fi
        done
      register: domain_add

    - name: "Show domain results"
      debug:
        msg: "{{ domain_add.stdout_lines }}"

    - name: "Wait for domains to initialize"
      pause:
        seconds: 10

    - name: "Create zone mapping"
      shell: |
        rm -f /tmp/zone_mapping.txt
        for domain in $(cat /tmp/domains.csv); do
          [ -z "$domain" ] && continue
          zone_id=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name=${domain}" \
            -H "X-Auth-Email: {{ cf_email }}" \
            -H "X-Auth-Key: {{ cf_api_key }}" \
            -H "Content-Type: application/json" | python3 -c "import sys, json; d=json.load(sys.stdin); print(d['result'][0]['id'] if d.get('result') and len(d['result']) > 0 else 'NOT_FOUND')")
          echo "${domain},${zone_id}" >> /tmp/zone_mapping.txt
          echo "âœ… ${domain} = ${zone_id}"
          sleep 1
        done
      register: zone_mapping

    - name: "Show zone mapping"
      debug:
        msg: "{{ zone_mapping.stdout_lines }}"

    - name: "Get Nameservers"
      shell: |
        rm -f /tmp/nameservers.txt /tmp/nameservers_csv.txt
        echo "Domain,NS1,NS2" > /tmp/nameservers_csv.txt
        echo "=== NAMESERVERS ===" > /tmp/nameservers.txt
        while IFS=',' read -r domain zone_id; do
          [ -z "$domain" ] && continue
          [ "$zone_id" = "NOT_FOUND" ] && continue
          
          echo "Getting NS for ${domain}..."
          
          zone_info=$(curl -s -X GET "https://api.cloudflare.com/client/v4/zones/${zone_id}" \
            -H "X-Auth-Email: {{ cf_email }}" \
            -H "X-Auth-Key: {{ cf_api_key }}" \
            -H "Content-Type: application/json")
          
          ns_list=$(echo "$zone_info" | python3 -c "import sys, json; d=json.load(sys.stdin); ns=d.get('result',{}).get('name_servers',[]); print(','.join(ns))")
          
          echo "${domain}:" >> /tmp/nameservers.txt
          echo "$ns_list" >> /tmp/nameservers.txt
          echo "${domain},${ns_list}" >> /tmp/nameservers_csv.txt
          echo "" >> /tmp/nameservers.txt
          sleep 1
        done < /tmp/zone_mapping.txt
      register: ns_get

    - name: "Show Nameservers"
      shell: cat /tmp/nameservers.txt
      register: ns_display

    - name: "Display NS"
      debug:
        msg: "{{ ns_display.stdout }}"

    - name: "Show NS CSV for Registrar"
      shell: cat /tmp/nameservers_csv.txt
      register: csv_output

    - name: "Display NS CSV"
      debug:
        msg: |
          ðŸ“‹ COPY THIS TO YOUR REGISTRAR:
          
          {{ csv_output.stdout }}

    - name: "Create DNS A records"
      shell: |
        ip="{{ ansible_default_ipv4.address }}"
        rm -f /tmp/dns_records_created.txt
        echo "=== CREATED DNS RECORDS ===" > /tmp/dns_records_created.txt

        while IFS=',' read -r domain zone_id; do
          [ -z "$domain" ] && continue
          [ "$zone_id" = "NOT_FOUND" ] && continue

          echo "Processing ${domain}..."
          echo "${domain}:" >> /tmp/dns_records_created.txt

          # Root domain
          echo "  Creating: ${domain} â†’ ${ip}"
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records" \
            -H "X-Auth-Email: {{ cf_email }}" \
            -H "X-Auth-Key: {{ cf_api_key }}" \
            -H "Content-Type: application/json" \
            -d "{\"type\":\"A\",\"name\":\"${domain}\",\"content\":\"${ip}\",\"ttl\":1,\"proxied\":true}" > /dev/null 2>&1
          echo "    âœ… ${domain}" >> /tmp/dns_records_created.txt
          sleep 0.5

          # Wildcard
          echo "  Creating: *.${domain} â†’ ${ip}"
          curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records" \
            -H "X-Auth-Email: {{ cf_email }}" \
            -H "X-Auth-Key: {{ cf_api_key }}" \
            -H "Content-Type: application/json" \
            -d "{\"type\":\"A\",\"name\":\"*.${domain}\",\"content\":\"${ip}\",\"ttl\":1,\"proxied\":true}" > /dev/null 2>&1
          echo "    âœ… *.${domain}" >> /tmp/dns_records_created.txt
          sleep 0.5

          # Subdomains
          while IFS= read -r subdomain; do
            [ -z "$subdomain" ] && continue

            full_domain="${subdomain}.${domain}"
            echo "  Creating: ${full_domain} â†’ ${ip}"
            curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${zone_id}/dns_records" \
              -H "X-Auth-Email: {{ cf_email }}" \
              -H "X-Auth-Key: {{ cf_api_key }}" \
              -H "Content-Type: application/json" \
              -d "{\"type\":\"A\",\"name\":\"${full_domain}\",\"content\":\"${ip}\",\"ttl\":1,\"proxied\":true}" > /dev/null 2>&1
            echo "    âœ… ${full_domain}" >> /tmp/dns_records_created.txt
            sleep 0.5
          done < /tmp/subdomains.csv

          echo "" >> /tmp/dns_records_created.txt
        done < /tmp/zone_mapping.txt
      register: dns_creation

    - name: "Show DNS creation output"
      debug:
        msg: "{{ dns_creation.stdout_lines }}"

    - name: "Show created DNS records"
      shell: cat /tmp/dns_records_created.txt
      register: dns_output

    - name: "Display DNS records"
      debug:
        msg: "{{ dns_output.stdout }}"

    - name: "Final Summary"
      debug:
        msg: |
          âœ… CLOUDFLARE SETUP COMPLETE!
          
          ðŸ“ CREATED FILES:
          - /tmp/zone_mapping.txt
          - /tmp/nameservers_csv.txt (â­ COPY TO REGISTRAR)
          - /tmp/dns_records_created.txt
          
          ðŸŽ¯ NEXT STEPS:
          1. Copy NS from /tmp/nameservers_csv.txt
          2. Update registrar with new NS
          3. Wait 24-48 hours
          4. Verify DNS propagation
