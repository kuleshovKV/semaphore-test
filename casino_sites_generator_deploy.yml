---
- name: "ğŸ° CASINO SITES GENERATOR & DEPLOY - PRODUCTION"
  hosts: all
  gather_facts: yes
  vars:
    work_dir: "/var/www/casino_generator"
    output_dir: "/var/www"
    deployment_cache: "{{ output_dir }}/.deployment_cache"
    subdirs:
      - register
      - bonus
      - reviews
      - withdrawal

  tasks:
    - name: "ğŸ“‹ Display Deployment Info"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘ ğŸ° CASINO SITES GENERATOR & DEPLOY v4.0 (FIXED) â•‘
          â•‘                                                    â•‘
          â•‘ Server: {{ inventory_hostname }}                   â•‘
          â•‘ Work dir: {{ work_dir }}                          â•‘
          â•‘ Output: {{ output_dir }}                          â•‘
          â•‘ Date: {{ ansible_date_time.iso8601 }}             â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    # ========== GIT REPOSITORY ==========
    - name: "ğŸ“ Create work directory"
      file:
        path: "{{ work_dir }}"
        state: directory
        mode: '0755'

    - name: "ğŸ“¥ Check if git repo exists"
      stat:
        path: "{{ work_dir }}/.git"
      register: git_dir

    - name: "ğŸ“¥ Clone repository if not exists"
      git:
        repo: "https://github.com/kuleshovKV/semaphore-test.git"
        dest: "{{ work_dir }}"
        version: master
      when: not git_dir.stat.exists

    - name: "ğŸ“¥ Update existing repository"
      shell: |
        cd {{ work_dir }}
        git fetch origin
        git checkout -f master
        git reset --hard origin/master
      when: git_dir.stat.exists
      register: git_update

    # ========== PARSING CSV FILES ==========
    - name: "ğŸ“¥ Read domains.csv"
      slurp:
        src: "{{ work_dir }}/domains.csv"
      register: domains_content

    - name: "ğŸ“¥ Read brands.csv"
      slurp:
        src: "{{ work_dir }}/brands.csv"
      register: brands_content

    - name: "ğŸ“¥ Read ref_links.conf"
      slurp:
        src: "{{ work_dir }}/ref_links.conf"
      register: refs_content

    - name: "ğŸ” Parse domains"
      set_fact:
        domains: "{{ (domains_content.content | b64decode).strip().split('\n') | reject('equalto', '') | list }}"

    - name: "ğŸ” Parse brands"
      set_fact:
        brands: "{{ (brands_content.content | b64decode).strip().split('\n') | reject('equalto', '') | list }}"

    - name: "ğŸ” Parse ref_links"
      set_fact:
        refs_raw: "{{ (refs_content.content | b64decode).strip().split('\n') | reject('equalto', '') | list }}"

    - name: "âœ… Display parsed data"
      debug:
        msg: |
          âœ… Parsed configuration:
          ğŸ“‹ Domains: {{ domains | length }} entries
          ğŸ¯ Brands: {{ brands | length }} entries
          ğŸ”— Ref links: {{ refs_raw | length }} entries
          ğŸ“ˆ TOTAL SITES: {{ (domains | length) * (brands | length) }}

    # ========== CHECK DEPLOYMENT CACHE ==========
    - name: "ğŸ’¾ Check deployment cache"
      stat:
        path: "{{ deployment_cache }}"
      register: cache_stat

    - name: "ğŸ’¾ Load last deployment hash"
      set_fact:
        last_deployment_hash: "{{ lookup('file', deployment_cache) | regex_search('HASH=([a-f0-9]+)', '\\1') | first }}"
      when: cache_stat.stat.exists
      ignore_errors: yes

    - name: "ğŸ” Calculate current hash"
      set_fact:
        current_hash: "{{ (domains | join(',') + ':' + brands | join(',')) | hash('md5') }}"

    - name: "â­ï¸ Skip if already deployed"
      meta: end_play
      when:
        - cache_stat.stat.exists
        - last_deployment_hash is defined
        - last_deployment_hash == current_hash

    - name: "ğŸš€ Starting fresh deployment"
      debug:
        msg: "ğŸš€ Hash changed or first run - proceeding with deployment"

    # ========== CREATE DIRECTORIES ==========
    - name: "ğŸ“ Create site directories"
      file:
        path: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}"
        state: directory
        mode: '0755'
        recurse: yes
      loop: "{{ domains | product(brands) | list }}"
      loop_control:
        label: "{{ item[1] }}/{{ item[0] }}"
      register: dir_creation

    - name: "ğŸ“ Create subdirectories"
      file:
        path: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}/{{ item[2] }}"
        state: directory
        mode: '0755'
      loop: "{{ domains | product(brands, subdirs) | list }}"
      loop_control:
        label: "{{ item[1] }}/{{ item[2] }}"

    # ========== GENERATE HTML PAGES ==========
    - name: "ğŸ“ Generate main pages (index.html)"
      copy:
        dest: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}/index.html"
        content: |
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <meta name="robots" content="index, follow">
              <title>{{ item[1] | upper }} - {{ item[0] | title }} | Ğ›ÑƒÑ‡ÑˆĞµĞµ ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾ Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½</title>
              <meta name="description" content="Ğ˜Ğ³Ñ€Ğ°Ğ¹Ñ‚Ğµ Ğ² {{ item[1] | upper }} Ğ¸ Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ğ²Ğ°Ğ¹Ñ‚Ğµ Ğ² Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½ ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾ {{ item[0] }}. Ğ›Ğ¸Ñ†ĞµĞ½Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ½Ğ°Ñ Ğ¿Ğ»Ğ¾Ñ‰Ğ°Ğ´ĞºĞ° Ñ Ğ±Ğ¾Ğ½ÑƒÑĞ°Ğ¼Ğ¸ Ğ¸ Ğ±Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¼Ğ¸ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ğ°Ğ¼Ğ¸.">
              <meta name="keywords" content="{{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾, {{ item[0] }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾, Ğ¾Ğ½Ğ»Ğ°Ğ¹Ğ½ ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾, Ğ±Ğ¾Ğ½ÑƒÑÑ‹ ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾">
              <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' font-weight='bold' fill='%234CAF50'>{{ item[1][0] | upper }}</text></svg>">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body {
                      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                      color: #fff;
                      min-height: 100vh;
                      display: flex;
                      align-items: center;
                      justify-content: center;
                      padding: 20px;
                  }
                  .container {
                      max-width: 600px;
                      background: rgba(255,255,255,0.1);
                      border-radius: 10px;
                      padding: 40px;
                      backdrop-filter: blur(10px);
                      box-shadow: 0 8px 32px rgba(31,38,135,0.37);
                  }
                  h1 {
                      font-size: 2.5em;
                      margin-bottom: 20px;
                      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
                  }
                  .domain { font-weight: bold; color: #FFD700; }
                  .brand { color: #00FF88; }
                  p { margin: 10px 0; }
                  nav {
                      margin-top: 30px;
                      display: flex;
                      gap: 10px;
                      flex-wrap: wrap;
                  }
                  a {
                      display: inline-block;
                      padding: 10px 20px;
                      background: rgba(255,255,255,0.2);
                      border-radius: 5px;
                      color: #fff;
                      text-decoration: none;
                      transition: all 0.3s ease;
                  }
                  a:hover {
                      background: rgba(255,255,255,0.4);
                      transform: translateY(-2px);
                  }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ° <span class="brand">{{ item[1] | upper }}</span></h1>
                  <p>Ğ”Ğ¾Ğ¼ĞµĞ½: <span class="domain">{{ item[0] }}</span></p>
                  <p>Ğ‘Ñ€ĞµĞ½Ğ´: <span class="brand">{{ item[1] }}</span></p>
                  <p>Ğ ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³: â­â­â­â­â­ 4.8/5</p>
                  <nav>
                      <a href="./register/">ğŸ“ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</a>
                      <a href="./bonus/">ğŸ Ğ‘Ğ¾Ğ½ÑƒÑÑ‹</a>
                      <a href="./reviews/">â­ ĞÑ‚Ğ·Ñ‹Ğ²Ñ‹</a>
                      <a href="./withdrawal/">ğŸ’° Ğ’Ñ‹Ğ²Ğ¾Ğ´</a>
                  </nav>
              </div>
              <script>
                  // YandexBot cloaking
                  const ua = navigator.userAgent;
                  if (ua.indexOf('YandexBot') > -1 || ua.indexOf('Yandex') > -1) {
                      document.body.innerHTML = '<h1>SEO Content</h1><p>{{ item[1] | upper }} - {{ item[0] }}</p>';
                  }
              </script>
          </body>
          </html>
        force: no
        backup: no
      loop: "{{ domains | product(brands) | list }}"
      loop_control:
        label: "{{ item[1] }}/index.html"
      register: main_pages_created

    - name: "ğŸ“ Generate register pages"
      copy:
        dest: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}/register/index.html"
        content: |
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ - {{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾ {{ item[0] }}</title>
              <meta name="description" content="Ğ‘Ñ‹ÑÑ‚Ñ€Ğ°Ñ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ Ğ² {{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾. 5 ÑˆĞ°Ğ³Ğ¾Ğ² Ğº Ğ½Ğ°Ñ‡Ğ°Ğ»Ñƒ Ğ¸Ğ³Ñ€Ñ‹ Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡ĞµĞ½Ğ¸Ñ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ğ¾Ğ³Ğ¾ Ğ±Ğ¾Ğ½ÑƒÑĞ°.">
              <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' font-weight='bold' fill='%234CAF50'>{{ item[1][0] | upper }}</text></svg>">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
                  .container { max-width: 600px; margin: 30px auto; background: white; padding: 30px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
                  h1 { color: #333; margin-bottom: 20px; }
                  .steps { counter-reset: step-counter; }
                  .step { counter-increment: step-counter; margin: 15px 0; padding: 15px; background: #f9f9f9; border-left: 4px solid #667eea; }
                  .step::before { content: counter(step-counter); display: inline-block; width: 30px; height: 30px; background: #667eea; color: white; border-radius: 50%; text-align: center; line-height: 30px; margin-right: 10px; font-weight: bold; }
                  form { margin-top: 30px; }
                  input { display: block; width: 100%; margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px; }
                  button { width: 100%; margin-top: 20px; padding: 10px; background: #667eea; color: white; border: none; cursor: pointer; border-radius: 4px; font-size: 16px; }
                  button:hover { background: #764ba2; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ“ Ğ ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ñ</h1>
                  <p>Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€ÑƒĞ¹Ñ‚ĞµÑÑŒ Ğ² {{ item[1] | upper }} Ğ¸ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚Ğµ Ğ¿Ñ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ğ½ÑƒÑ Ğ´Ğ¾ 100,000 Ñ€ÑƒĞ±.</p>
                  <div class="steps">
                      <div class="step">Ğ—Ğ°Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ Ñ„Ğ¾Ñ€Ğ¼Ñƒ Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ°Ñ†Ğ¸Ğ¸</div>
                      <div class="step">ĞŸĞ¾Ğ´Ñ‚Ğ²ĞµÑ€Ğ´Ğ¸Ñ‚Ğµ email</div>
                      <div class="step">Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚Ğµ Ğ¿Ğ°Ñ€Ğ¾Ğ»ÑŒ</div>
                      <div class="step">ĞŸĞ¾Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚Ğµ ÑÑ‡ĞµÑ‚</div>
                      <div class="step">ĞĞ°Ñ‡Ğ½Ğ¸Ñ‚Ğµ Ğ¸Ğ³Ñ€Ğ°Ñ‚ÑŒ</div>
                  </div>
                  <form>
                      <input type="email" placeholder="Email" required>
                      <input type="password" placeholder="ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ" required>
                      <input type="text" placeholder="Ğ˜Ğ¼Ñ" required>
                      <input type="tel" placeholder="Ğ¢ĞµĞ»ĞµÑ„Ğ¾Ğ½" required>
                      <button type="submit">Ğ—Ğ°Ñ€ĞµĞ³Ğ¸ÑÑ‚Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒÑÑ</button>
                  </form>
              </div>
          </body>
          </html>
        force: no
        backup: no
      loop: "{{ domains | product(brands) | list }}"
      loop_control:
        label: "{{ item[1] }}/register/index.html"

    - name: "ğŸ Generate bonus pages"
      copy:
        dest: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}/bonus/index.html"
        content: |
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Ğ‘Ğ¾Ğ½ÑƒÑÑ‹ - {{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾ {{ item[0] }}</title>
              <meta name="description" content="Ğ©ĞµĞ´Ñ€Ñ‹Ğµ Ğ±Ğ¾Ğ½ÑƒÑÑ‹ Ğ² {{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾. ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğµ Ñ„Ñ€Ğ¸ÑĞ¿Ğ¸Ğ½Ñ‹, ĞºĞµÑˆĞ±ÑĞº Ğ¸ ĞµĞ¶ĞµĞ´Ğ½ĞµĞ²Ğ½Ñ‹Ğµ Ğ°ĞºÑ†Ğ¸Ğ¸.">
              <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' font-weight='bold' fill='%234CAF50'>{{ item[1][0] | upper }}</text></svg>">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
                  .container { max-width: 600px; margin: 30px auto; background: white; padding: 30px; border-radius: 8px; }
                  h1 { color: #333; margin-bottom: 20px; }
                  table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                  th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                  th { background: #667eea; color: white; }
                  tr:hover { background: #f5f5f5; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ Ğ‘Ğ¾Ğ½ÑƒÑÑ‹ {{ item[1] | upper }}</h1>
                  <table>
                      <thead>
                          <tr>
                              <th>Ğ¢Ğ¸Ğ¿ Ğ±Ğ¾Ğ½ÑƒÑĞ°</th>
                              <th>Ğ Ğ°Ğ·Ğ¼ĞµÑ€</th>
                              <th>Ğ£ÑĞ»Ğ¾Ğ²Ğ¸Ñ</th>
                          </tr>
                      </thead>
                      <tbody>
                          <tr>
                              <td>ĞŸÑ€Ğ¸Ğ²ĞµÑ‚ÑÑ‚Ğ²ĞµĞ½Ğ½Ñ‹Ğ¹ Ğ±Ğ¾Ğ½ÑƒÑ</td>
                              <td>100,000 Ñ€ÑƒĞ±</td>
                              <td>Ğ’ĞµĞ¹Ğ´Ğ¶ĞµÑ€ Ñ…35</td>
                          </tr>
                          <tr>
                              <td>Ğ‘ĞµÑĞ¿Ğ»Ğ°Ñ‚Ğ½Ñ‹Ğµ ÑĞ¿Ğ¸Ğ½Ñ‹</td>
                              <td>100 Ñ„Ñ€Ğ¸ÑĞ¿Ğ¸Ğ½Ğ¾Ğ²</td>
                              <td>ĞĞ° Ğ¿Ğ¾Ğ¿ÑƒĞ»ÑÑ€Ğ½Ñ‹Ñ… ÑĞ»Ğ¾Ñ‚Ğ°Ñ…</td>
                          </tr>
                          <tr>
                              <td>ĞšĞµÑˆĞ±ÑĞº</td>
                              <td>10%</td>
                              <td>Ğ•Ğ¶ĞµĞ½ĞµĞ´ĞµĞ»ÑŒĞ½Ğ¾</td>
                          </tr>
                          <tr>
                              <td>Reload Ğ±Ğ¾Ğ½ÑƒÑ</td>
                              <td>50%</td>
                              <td>ĞŸÑ€Ğ¸ Ğ¿Ğ¾Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğ¸ ÑÑ‡ĞµÑ‚Ğ°</td>
                          </tr>
                      </tbody>
                  </table>
              </div>
          </body>
          </html>
        force: no
        backup: no
      loop: "{{ domains | product(brands) | list }}"
      loop_control:
        label: "{{ item[1] }}/bonus/index.html"

    - name: "â­ Generate reviews pages"
      copy:
        dest: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}/reviews/index.html"
        content: |
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>ĞÑ‚Ğ·Ñ‹Ğ²Ñ‹ - {{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾ {{ item[0] }}</title>
              <meta name="description" content="Ğ§Ğ¸Ñ‚Ğ°Ğ¹Ñ‚Ğµ Ñ€ĞµĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ¸Ğ³Ñ€Ğ¾ĞºĞ¾Ğ² Ğ¾ {{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞµĞ½Ğ½Ğ°Ñ Ñ€ĞµĞ¿ÑƒÑ‚Ğ°Ñ†Ğ¸Ñ Ğ¸ Ğ²Ñ‹ÑĞ¾ĞºĞ¸Ğµ Ñ€ĞµĞ¹Ñ‚Ğ¸Ğ½Ğ³Ğ¸.">
              <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' font-weight='bold' fill='%234CAF50'>{{ item[1][0] | upper }}</text></svg>">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
                  .container { max-width: 600px; margin: 30px auto; background: white; padding: 30px; border-radius: 8px; }
                  h1 { color: #333; margin-bottom: 20px; }
                  .rating { font-size: 24px; color: #FFD700; margin: 20px 0; }
                  .review { background: #f9f9f9; padding: 15px; margin: 15px 0; border-radius: 5px; border-left: 4px solid #667eea; }
                  .review-author { font-weight: bold; color: #333; }
                  .review-text { margin-top: 10px; color: #666; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>â­ ĞÑ‚Ğ·Ñ‹Ğ²Ñ‹ Ğ¾ {{ item[1] | upper }}</h1>
                  <div class="rating">â­â­â­â­â­ 4.8/5.0 (5000+ Ğ¾Ñ‚Ğ·Ñ‹Ğ²Ğ¾Ğ²)</div>
                  <div class="review">
                      <div class="review-author">ĞĞ»ĞµĞºÑĞ°Ğ½Ğ´Ñ€ Ğš.</div>
                      <div class="review-text">ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ¾Ğµ ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾! Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğµ Ğ²Ñ‹Ğ¿Ğ»Ğ°Ñ‚Ñ‹ Ğ¸ Ñ‰ĞµĞ´Ñ€Ñ‹Ğµ Ğ±Ğ¾Ğ½ÑƒÑÑ‹. Ğ ĞµĞºĞ¾Ğ¼ĞµĞ½Ğ´ÑƒÑ!</div>
                  </div>
                  <div class="review">
                      <div class="review-author">ĞœĞ°Ñ€Ğ¸Ñ ĞŸ.</div>
                      <div class="review-text">Ğ˜Ğ³Ñ€Ğ°Ñ Ğ·Ğ´ĞµÑÑŒ ÑƒĞ¶Ğµ Ğ³Ğ¾Ğ´. ĞŸĞ¾Ğ»ÑƒÑ‡Ğ¸Ğ»Ğ° Ğ²Ñ‹Ğ¸Ğ³Ñ€Ñ‹Ñˆ 150,000 Ñ€ÑƒĞ± Ğ±ĞµĞ· Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼.</div>
                  </div>
                  <div class="review">
                      <div class="review-author">Ğ˜Ğ²Ğ°Ğ½ Ğ¡.</div>
                      <div class="review-text">ĞÑ‚Ğ»Ğ¸Ñ‡Ğ½Ğ°Ñ Ğ¿Ğ¾Ğ´Ğ´ĞµÑ€Ğ¶ĞºĞ°. ĞÑ‚Ğ²ĞµÑ‚Ğ¸Ğ»Ğ¸ Ğ·Ğ° 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ½Ğ° Ğ¼Ğ¾Ğ¹ Ğ²Ğ¾Ğ¿Ñ€Ğ¾Ñ.</div>
                  </div>
              </div>
          </body>
          </html>
        force: no
        backup: no
      loop: "{{ domains | product(brands) | list }}"
      loop_control:
        label: "{{ item[1] }}/reviews/index.html"

    - name: "ğŸ’° Generate withdrawal pages"
      copy:
        dest: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}/withdrawal/index.html"
        content: |
          <!DOCTYPE html>
          <html lang="ru">
          <head>
              <meta charset="UTF-8">
              <meta name="viewport" content="width=device-width, initial-scale=1.0">
              <title>Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ´ĞµĞ½ĞµĞ³ - {{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾ {{ item[0] }}</title>
              <meta name="description" content="Ğ‘Ñ‹ÑÑ‚Ñ€Ñ‹Ğ¹ Ğ¸ Ğ½Ğ°Ğ´ĞµĞ¶Ğ½Ñ‹Ğ¹ Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ´ĞµĞ½ĞµĞ³ Ğ² {{ item[1] | upper }} ĞºĞ°Ğ·Ğ¸Ğ½Ğ¾. ĞœĞ½Ğ¾Ğ¶ĞµÑÑ‚Ğ²Ğ¾ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ¾Ğ² Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶ĞµĞ¹ Ğ¸ Ğ¼Ğ¸Ğ½Ğ¸Ğ¼Ğ°Ğ»ÑŒĞ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ¸ÑÑĞ¸Ğ¸.">
              <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='75' font-size='75' font-weight='bold' fill='%234CAF50'>{{ item[1][0] | upper }}</text></svg>">
              <style>
                  * { margin: 0; padding: 0; box-sizing: border-box; }
                  body { font-family: Arial, sans-serif; background: #f0f0f0; padding: 20px; }
                  .container { max-width: 600px; margin: 30px auto; background: white; padding: 30px; border-radius: 8px; }
                  h1 { color: #333; margin-bottom: 20px; }
                  .payment-method { background: #f9f9f9; padding: 15px; margin: 15px 0; border-radius: 5px; }
                  .payment-method h3 { color: #667eea; margin-bottom: 10px; }
                  table { width: 100%; margin-top: 20px; border-collapse: collapse; }
                  th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
                  th { background: #667eea; color: white; }
              </style>
          </head>
          <body>
              <div class="container">
                  <h1>ğŸ’° Ğ’Ñ‹Ğ²Ğ¾Ğ´ Ğ´ĞµĞ½ĞµĞ³</h1>
                  <p>Ğ’ {{ item[1] | upper }} Ğ²Ñ‹Ğ²Ğ¾Ğ´ Ğ´ĞµĞ½ĞµĞ³ Ğ·Ğ°Ğ½Ğ¸Ğ¼Ğ°ĞµÑ‚ Ğ¾Ñ‚ 5 Ğ¼Ğ¸Ğ½ÑƒÑ‚ Ğ´Ğ¾ 3 Ñ‡Ğ°ÑĞ¾Ğ² Ğ² Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ Ğ¾Ñ‚ ÑĞ¿Ğ¾ÑĞ¾Ğ±Ğ° Ğ¿Ğ»Ğ°Ñ‚ĞµĞ¶Ğ°.</p>
                  <div class="payment-method">
                      <h3>ğŸ¦ Ğ‘Ğ°Ğ½ĞºĞ¾Ğ²ÑĞºĞ°Ñ ĞºĞ°Ñ€Ñ‚Ğ°</h3>
                      <p>ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼: 100 Ñ€ÑƒĞ± | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼: 1,000,000 Ñ€ÑƒĞ±</p>
                      <p>Ğ’Ñ€ĞµĞ¼Ñ: 1-3 Ñ€Ğ°Ğ±Ğ¾Ñ‡Ğ¸Ñ… Ğ´Ğ½Ñ</p>
                  </div>
                  <div class="payment-method">
                      <h3>ğŸ“± Ğ­Ğ»ĞµĞºÑ‚Ñ€Ğ¾Ğ½Ğ½Ñ‹Ğµ ĞºĞ¾ÑˆĞµĞ»ÑŒĞºĞ¸</h3>
                      <p>ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼: 50 Ñ€ÑƒĞ± | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼: 500,000 Ñ€ÑƒĞ±</p>
                      <p>Ğ’Ñ€ĞµĞ¼Ñ: 5-30 Ğ¼Ğ¸Ğ½ÑƒÑ‚</p>
                  </div>
                  <div class="payment-method">
                      <h3>ğŸ’³ ĞšÑ€Ğ¸Ğ¿Ñ‚Ğ¾Ğ²Ğ°Ğ»ÑÑ‚Ğ°</h3>
                      <p>ĞœĞ¸Ğ½Ğ¸Ğ¼ÑƒĞ¼: 1000 Ñ€ÑƒĞ± | ĞœĞ°ĞºÑĞ¸Ğ¼ÑƒĞ¼: Ğ±ĞµĞ· Ğ»Ğ¸Ğ¼Ğ¸Ñ‚Ğ°</p>
                      <p>Ğ’Ñ€ĞµĞ¼Ñ: 10-60 Ğ¼Ğ¸Ğ½ÑƒÑ‚</p>
                  </div>
              </div>
          </body>
          </html>
        force: no
        backup: no
      loop: "{{ domains | product(brands) | list }}"
      loop_control:
        label: "{{ item[1] }}/withdrawal/index.html"

    # ========== STATIC FILES ==========
    - name: "ğŸ“„ Generate robots.txt"
      copy:
        dest: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}/robots.txt"
        content: |
          User-agent: *
          Disallow: /admin
          Disallow: /private
          Allow: /
          Sitemap: https://{{ item[1] }}.{{ item[0] }}/sitemap.xml
        force: no
      loop: "{{ domains | product(brands) | list }}"
      loop_control:
        label: "{{ item[1] }}/robots.txt"

    - name: "ğŸ—ºï¸ Generate sitemap.xml"
      copy:
        dest: "{{ output_dir }}/{{ item[0] }}/{{ item[1] }}/sitemap.xml"
        content: |
          <?xml version="1.0" encoding="UTF-8"?>
          <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
              <url>
                  <loc>https://{{ item[1] }}.{{ item[0] }}/</loc>
                  <priority>1.0</priority>
              </url>
              <url>
                  <loc>https://{{ item[1] }}.{{ item[0] }}/register/</loc>
                  <priority>0.9</priority>
              </url>
              <url>
                  <loc>https://{{ item[1] }}.{{ item[0] }}/bonus/</loc>
                  <priority>0.8</priority>
              </url>
              <url>
                  <loc>https://{{ item[1] }}.{{ item[0] }}/reviews/</loc>
                  <priority>0.7</priority>
              </url>
              <url>
                  <loc>https://{{ item[1] }}.{{ item[0] }}/withdrawal/</loc>
                  <priority>0.7</priority>
              </url>
          </urlset>
        force: no
      loop: "{{ domains | product(brands) | list }}"
      loop_control:
        label: "{{ item[1] }}/sitemap.xml"

    # ========== CACHE & FINALIZATION ==========
    - name: "ğŸ“ Count generated files"
      find:
        paths: "{{ output_dir }}"
        patterns: "index.html"
        recurse: yes
      register: html_files

    - name: "ğŸ’¾ Create deployment cache with hash"
      copy:
        content: |
          # Deployment Cache
          # Generated: {{ ansible_date_time.iso8601 }}
          # Hash: {{ current_hash }}
          HASH={{ current_hash }}
          DOMAINS={{ domains | length }}
          BRANDS={{ brands | length }}
          TOTAL_SITES={{ (domains | length) * (brands | length) }}
          TOTAL_PAGES={{ html_files.matched }}
          DEPLOYMENT_TIME={{ ansible_date_time.iso8601 }}
        dest: "{{ deployment_cache }}"
        force: yes
      register: cache_updated

    - name: "âœ… Set correct permissions"
      file:
        path: "{{ output_dir }}"
        owner: www-data
        group: www-data
        mode: '0755'
        recurse: yes

    - name: "ğŸ‰ Deployment Complete"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘ âœ… DEPLOYMENT COMPLETED SUCCESSFULLY!                â•‘
          â•‘                                                      â•‘
          â•‘ ğŸ“Š Statistics:                                      â•‘
          â•‘ - Domains created: {{ domains | length }}           â•‘
          â•‘ - Brands deployed: {{ brands | length }}            â•‘
          â•‘ - Site combinations: {{ (domains | length) * (brands | length) }} â•‘
          â•‘ - Subdirectories per site: {{ subdirs | length }}   â•‘
          â•‘ - Total HTML pages: {{ html_files.matched }}        â•‘
          â•‘                                                      â•‘
          â•‘ ğŸ“ Root directory: {{ output_dir }}                 â•‘
          â•‘ ğŸ’¾ Cache file: {{ deployment_cache }}               â•‘
          â•‘ ğŸ‘¤ Owner: www-data:www-data                         â•‘
          â•‘ â±ï¸ Timestamp: {{ ansible_date_time.iso8601 }}       â•‘
          â•‘                                                      â•‘
          â•‘ ğŸš€ All sites are Production Ready!                  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
