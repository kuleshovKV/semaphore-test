---
- name: "ğŸ° CASINO SITES GENERATOR & DEPLOY - PRODUCTION"
  hosts: all
  gather_facts: yes
  vars:
    work_dir: "/var/www/casino_generator"
    output_dir: "/var/www"

  tasks:
    - name: "ğŸ“‹ Display Deployment Info"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘ ğŸ° CASINO SITES GENERATOR & DEPLOY v3.0 â•‘
          â•‘ â•‘
          â•‘ Server: {{ inventory_hostname }}
          â•‘ Work dir: {{ work_dir }}
          â•‘ Output: {{ output_dir }}
          â•‘ Date: {{ ansible_date_time.iso8601 }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: "ğŸ“ Create work directories"
      file:
        path: "{{ work_dir }}/{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - templates
        - output
        - logs

    - name: "ğŸ“¥ Clone/update git repository"
      git:
        repo: "https://github.com/kuleshovKV/semaphore-test.git"
        dest: "{{ work_dir }}"
        version: master
        force: yes
      register: git_clone

    - name: "ğŸ“Š Display git status"
      debug:
        msg: "âœ… Git: {{ git_clone.changed | ternary('Updated', 'Already up to date') }}"

    - name: "ğŸ“¥ Read domains.csv"
      slurp:
        src: "{{ work_dir }}/domains.csv"
      register: domains_content

    - name: "ğŸ“¥ Read brands.csv"
      slurp:
        src: "{{ work_dir }}/brands.csv"
      register: brands_content

    - name: "ğŸ“¥ Read ref_links.conf"
      slurp:
        src: "{{ work_dir }}/ref_links.conf"
      register: refs_content

    - name: "ğŸ” Parse configuration"
      set_fact:
        domains: "{{ domains_content['content'] | b64decode | split('\n') | select('match', '^[a-z]') | list }}"
        brands: "{{ brands_content['content'] | b64decode | split('\n') | select('match', '^[a-z]') | list }}"
        refs_raw: "{{ refs_content['content'] | b64decode | split('\n') | select('match', '^[a-z]') | list }}"

    - name: "âœ… Display parsed data"
      debug:
        msg: |
          âœ… Parsed configuration:
          ğŸ“‹ Domains: {{ domains | length }} entries
          ğŸ¯ Brands: {{ brands | length }} entries
          ğŸ”— Ref links: {{ refs_raw | length }} entries

    - name: "ğŸ”§ Generate HTML template"
      shell: |
        cd {{ work_dir }}
        sh index.html.tpl_FULL.sh > /tmp/template_gen.log 2>&1
      register: template_gen
      ignore_errors: yes

    - name: "âœ… Verify template"
      stat:
        path: "{{ work_dir }}/templates/index.html.tpl"
      register: template_stat

    - name: "ğŸ“Š Display template info"
      debug:
        msg: |
          âœ… Template generated
          ğŸ“Š Size: {{ (template_stat.stat.size / 1024) | round(1) }} KB
          âœ¨ Ready for generation

    - name: "ğŸ”§ Create generation script"
      shell: |
        cat > {{ work_dir }}/generate_sites.sh << 'GENEOF'
        #!/bin/sh
        cd {{ work_dir }}
        
        echo "ğŸ° Starting generation for {{ domains | length }} domains Ã— {{ brands | length }} brands..."
        
        {% for domain in domains %}
        {% set domain_name = domain.strip() %}
        {% for brand in brands %}
        {% set brand_name = brand.strip() %}
        
        SITE_DIR="{{ output_dir }}/{{ brand_name }}casino.{{ domain_name }}"
        mkdir -p "$SITE_DIR"/{register,bonus,reviews,withdrawal}
        
        # Main page
        sed "s|BRAND|{{ brand_name }}|g; s|DOMAIN|{{ domain_name }}|g" templates/index.html.tpl > "$SITE_DIR/index.html"
        
        # Subpages
        sed "s|BRAND|{{ brand_name }}|g; s|DOMAIN|{{ domain_name }}|g; s|PAGE|register|g" templates/index.html.tpl > "$SITE_DIR/register/index.html"
        sed "s|BRAND|{{ brand_name }}|g; s|DOMAIN|{{ domain_name }}|g; s|PAGE|bonus|g" templates/index.html.tpl > "$SITE_DIR/bonus/index.html"
        sed "s|BRAND|{{ brand_name }}|g; s|DOMAIN|{{ domain_name }}|g; s|PAGE|reviews|g" templates/index.html.tpl > "$SITE_DIR/reviews/index.html"
        sed "s|BRAND|{{ brand_name }}|g; s|DOMAIN|{{ domain_name }}|g; s|PAGE|withdrawal|g" templates/index.html.tpl > "$SITE_DIR/withdrawal/index.html"
        
        # Static files
        echo "User-agent: *" > "$SITE_DIR/robots.txt"
        echo "Disallow: /admin" >> "$SITE_DIR/robots.txt"
        echo "Allow: /" >> "$SITE_DIR/robots.txt"
        
        echo "<?xml version=\"1.0\" encoding=\"UTF-8\"?>" > "$SITE_DIR/sitemap.xml"
        echo "<urlset xmlns=\"http://www.sitemaps.org/schemas/sitemap/0.9\">" >> "$SITE_DIR/sitemap.xml"
        echo "  <url><loc>https://{{ brand_name }}casino.{{ domain_name }}/</loc></url>" >> "$SITE_DIR/sitemap.xml"
        echo "  <url><loc>https://{{ brand_name }}casino.{{ domain_name }}/register/</loc></url>" >> "$SITE_DIR/sitemap.xml"
        echo "  <url><loc>https://{{ brand_name }}casino.{{ domain_name }}/bonus/</loc></url>" >> "$SITE_DIR/sitemap.xml"
        echo "  <url><loc>https://{{ brand_name }}casino.{{ domain_name }}/reviews/</loc></url>" >> "$SITE_DIR/sitemap.xml"
        echo "  <url><loc>https://{{ brand_name }}casino.{{ domain_name }}/withdrawal/</loc></url>" >> "$SITE_DIR/sitemap.xml"
        echo "</urlset>" >> "$SITE_DIR/sitemap.xml"
        
        echo "âœ… Generated: {{ brand_name }}casino.{{ domain_name }}"
        {% endfor %}
        {% endfor %}
        
        echo "âœ… Total generated: {{ (domains | length) * (brands | length) }} sites"
        GENEOF
        
        chmod +x {{ work_dir }}/generate_sites.sh
      args:
        executable: /bin/sh

    - name: "ğŸš€ Run generation script"
      shell: "sh {{ work_dir }}/generate_sites.sh"
      register: generation_output

    - name: "âœ… Display generation output"
      debug:
        msg: "{{ generation_output.stdout }}"

    - name: "ğŸ“ Count generated files"
      find:
        paths: "{{ output_dir }}"
        patterns: "index.html"
        recurse: yes
      register: html_files

    - name: "ğŸ“Š Display verification"
      debug:
        msg: |
          âœ… Generation Results:
          ğŸ“ Total HTML files: {{ html_files.matched }}
          ğŸ“¦ Location: {{ output_dir }}
          ğŸ¯ Ready for production

    - name: "âœ… Set correct permissions"
      file:
        path: "{{ output_dir }}"
        owner: www-data
        group: www-data
        mode: '0755'
        recurse: yes

    - name: "ğŸ‰ Deployment Complete"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘ âœ… DEPLOYMENT COMPLETED! â•‘
          â•‘ â•‘
          â•‘ ğŸ“Š HTML Files: {{ html_files.matched }}
          â•‘ ğŸ“ Location: {{ output_dir }}
          â•‘ ğŸ‘¤ Owner: www-data:www-data
          â•‘ â•‘
          â•‘ ğŸš€ Production Ready! â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
