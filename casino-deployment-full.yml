---
- name: "ğŸ° CASINO DEPLOYMENT"
  hosts: all
  become: true
  gather_facts: yes
  
  vars:
    generator_dir: "/var/www/casino_generator"
    sites_dir: "/var/www/casino_sites"
    log_dir: "/var/log/casino-deployment"
    
  tasks:
    - name: "ğŸ“¦ Phase 1: Install dependencies"
      apt:
        name: imagemagick-6.q16
        state: present
        update_cache: yes
      ignore_errors: yes

    - name: "ğŸ“ Create directories"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ generator_dir }}"
        - "{{ sites_dir }}"
        - "{{ log_dir }}"

    - name: "ğŸ“¥ Phase 2: Clone repository"
      git:
        repo: "https://github.com/kuleshovKV/semaphore-test.git"
        dest: "{{ generator_dir }}"
        version: master
        force: yes
      retries: 3
      delay: 10

    - name: "ğŸš€ Run generation script"
      shell: |
        cd {{ generator_dir }}
        if [ -f generate_sites.sh ]; then
          bash generate_sites.sh 2>&1
        else
          echo "Script not found"
        fi
      ignore_errors: yes
      register: gen_output

    - name: "ğŸ“– Phase 3: Read domains"
      block:
        - name: "Check domains.csv"
          stat:
            path: "{{ generator_dir }}/domains.csv"
          register: csv_stat

        - name: "Read CSV"
          slurp:
            src: "{{ generator_dir }}/domains.csv"
          register: csv_content
          when: csv_stat.stat.exists

        - name: "Parse domains"
          set_fact:
            domains_list: "{{ (csv_content.content | b64decode).split('\n') | reject('match', '^$') | list }}"
          when: csv_stat.stat.exists

        - name: "Show count"
          debug:
            msg: "Domains: {{ domains_list | length | default(0) }}"

    - name: "â˜ï¸ Phase 4: Cloudflare API (curl)"
      block:
        - name: "Check domains in CF"
          shell: |
            curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name={{ item }}" \
              -H "X-Auth-Email: {{ cf_email }}" \
              -H "X-Auth-Key: {{ cf_api_key }}" \
              -H "Content-Type: application/json"
          register: cf_check
          loop: "{{ domains_list | default([]) }}"
          delay: 0.5

        - name: "Extract zone IDs"
          set_fact:
            zone_ids: "{{ cf_check.results | map(attribute='stdout') | map('from_json') | map(attribute='result') | map('first', {}) | map(attribute='id') | list }}"

    - name: "ğŸŒ Phase 5: Create DNS records"
      shell: |
        curl -s -X POST "https://api.cloudflare.com/client/v4/zones/{{ item.1 }}/dns_records" \
          -H "X-Auth-Email: {{ cf_email }}" \
          -H "X-Auth-Key: {{ cf_api_key }}" \
          -H "Content-Type: application/json" \
          -d '{"type":"A","name":"{{ item.0 }}","content":"{{ ansible_default_ipv4.address }}","ttl":1,"proxied":true}'
      loop: "{{ domains_list | default([]) | zip(zone_ids | default([])) | list }}"
      delay: 0.5
      ignore_errors: yes

    - name: "ğŸ”‘ Phase 7: Get nameservers"
      shell: |
        curl -s -X GET "https://api.cloudflare.com/client/v4/zones/{{ item }}" \
          -H "X-Auth-Email: {{ cf_email }}" \
          -H "X-Auth-Key: {{ cf_api_key }}" \
          -H "Content-Type: application/json"
      register: ns_info
      loop: "{{ zone_ids | default([]) }}"
      delay: 0.5
      ignore_errors: yes

    - name: "Extract nameservers"
      set_fact:
        nameserver_list: "{{ ns_info.results | map(attribute='stdout') | map('from_json') | map(attribute='result.name_servers') | list }}"

    - name: "ğŸ’¾ Phase 8: Save nameservers"
      copy:
        content: |
          Domain,Nameserver1,Nameserver2
          {% for domain, ns in (domains_list | default([]) | zip(nameserver_list | default([]))) %}
          {{ domain }},{{ ns[0] | default('') }},{{ ns[1] | default('') }}
          {% endfor %}
        dest: "{{ log_dir }}/NAMESERVERS_BULK_{{ inventory_hostname }}.csv"
        mode: '0644'

    - name: "ğŸ“¥ Phase 9: Download files"
      fetch:
        src: "{{ log_dir }}/NAMESERVERS_BULK_{{ inventory_hostname }}.csv"
        dest: "./fetched/{{ inventory_hostname }}/"
        flat: yes
      ignore_errors: yes

    - name: "âœ… Summary"
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… DEPLOYMENT COMPLETED!
          
          Host: {{ inventory_hostname }}
          Domains: {{ domains_list | length | default(0) }}
          
          Files in: {{ log_dir }}/
          Downloaded to: ./fetched/{{ inventory_hostname }}/
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
