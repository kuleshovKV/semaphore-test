---
# Casino Sites Generator v2.1 - Production Ready
# Reads: domains.csv, brands.csv, ref_links.conf from /root
# Generates: HTML sites + Git push

- name: "ğŸ° CASINO SITES GENERATOR v2.1 - PRODUCTION"
  hosts: localhost
  connection: local
  gather_facts: yes
  
  vars:
    work_dir: "/root"
    domains_file: "domains.csv"
    brands_file: "brands.csv"
    refs_file: "ref_links.conf"
    output_dir: "output"
    templates_dir: "templates"
    log_dir: "logs"

  pre_tasks:
    - name: "ğŸ° Display Generation Info"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  ğŸ° CASINO SITES GENERATOR v2.1 - PRODUCTION         â•‘
          â•‘                                                        â•‘
          â•‘  Work dir: {{ work_dir }}
          â•‘  Domains: {{ domains_file }}
          â•‘  Brands: {{ brands_file }}
          â•‘  Refs: {{ refs_file }}
          â•‘  Output: {{ output_dir }}
          â•‘  Date: {{ ansible_date_time.iso8601 }}
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

    - name: "âœ… Pre-flight Checks"
      block:
        - name: "Check domains.csv exists"
          stat:
            path: "{{ work_dir }}/{{ domains_file }}"
          register: domains_stat
          failed_when: not domains_stat.stat.exists

        - name: "Check brands.csv exists"
          stat:
            path: "{{ work_dir }}/{{ brands_file }}"
          register: brands_stat
          failed_when: not brands_stat.stat.exists

        - name: "Check ref_links.conf exists"
          stat:
            path: "{{ work_dir }}/{{ refs_file }}"
          register: refs_stat
          failed_when: not refs_stat.stat.exists

        - name: "Create output directories"
          file:
            path: "{{ work_dir }}/{{ item }}"
            state: directory
            mode: '0755'
          loop:
            - "{{ templates_dir }}"
            - "{{ output_dir }}"
            - "{{ log_dir }}"

        - name: "Display checks passed"
          debug:
            msg: |
              âœ… All files found:
              - {{ work_dir }}/{{ domains_file }}
              - {{ work_dir }}/{{ brands_file }}
              - {{ work_dir }}/{{ refs_file }}

  tasks:
    - name: "ğŸ“– STEP 1: Read Configuration Files"
      block:
        - name: "Read domains.csv"
          command: "cat {{ work_dir }}/{{ domains_file }}"
          register: domains_content
          changed_when: false

        - name: "Read brands.csv"
          command: "cat {{ work_dir }}/{{ brands_file }}"
          register: brands_content
          changed_when: false

        - name: "Read ref_links.conf"
          command: "cat {{ work_dir }}/{{ refs_file }}"
          register: refs_content
          changed_when: false

        - name: "Parse domains"
          set_fact:
            domains_list: "{{ domains_content.stdout_lines | select | list }}"

        - name: "Parse brands"
          set_fact:
            brands_list: "{{ brands_content.stdout_lines | select | list }}"

        - name: "Parse refs and extract default"
          set_fact:
            refs_dict: "{{ refs_dict | default({}) | combine({item.split('=')[0]: item.split('=')[1]}) }}"
            default_ref: "{{ item.split('=')[1] if 'default=' in item else default_ref | default('') }}"
          loop: "{{ refs_content.stdout_lines | select | list }}"

        - name: "Display parsed data"
          debug:
            msg: |
              âœ… Parsed configuration:
              ğŸ“‹ Domains: {{ domains_list | length }} entries
              ğŸ¯ Brands: {{ brands_list | length }} entries
              ğŸ”— Ref links: {{ refs_dict | length }} entries
              ğŸ“Œ Default ref: {{ default_ref[:50] }}...

    - name: "ğŸ”§ STEP 2: Generate HTML Template"
      block:
        - name: "Check if template script exists"
          stat:
            path: "{{ work_dir }}/index.html.tpl_FULL.sh"
          register: template_script

        - name: "Execute template generation script"
          shell: |
            cd {{ work_dir }}
            bash index.html.tpl_FULL.sh
          when: template_script.stat.exists
          register: template_result

        - name: "Verify template created"
          stat:
            path: "{{ work_dir }}/{{ templates_dir }}/index.html.tpl"
          register: template_stat
          failed_when: not template_stat.stat.exists

        - name: "Display template info"
          debug:
            msg: |
              âœ… Template generated
              ğŸ“Š Size: {{ (template_stat.stat.size / 1024) | round(2) }} KB
              âœ¨ Ready for site generation

    - name: "âš™ï¸ STEP 3: Generate Sites (Python Multi-threaded)"
      block:
        - name: "Create generation script"
          copy:
            content: |
              #!/usr/bin/env python3
              import os
              import sys
              import re
              from pathlib import Path
              from datetime import datetime
              from jinja2 import Environment, FileSystemLoader, select_autoescape

              class CasinoGenerator:
                  def __init__(self, domains, brands, refs, output_dir, templates_dir, default_ref):
                      self.domains = domains
                      self.brands = brands
                      self.refs = refs
                      self.default_ref = default_ref
                      self.output_dir = output_dir
                      self.templates_dir = templates_dir
                      self.generated = 0
                      
                      self.env = Environment(
                          loader=FileSystemLoader(templates_dir),
                          autoescape=select_autoescape(['html', 'xml'])
                      )

                  def get_ref_link(self, brand):
                      """Get ref link for brand or return default"""
                      brand_lower = brand.lower().replace(' casino', '').replace('casino', '').strip()
                      return self.refs.get(brand_lower, self.default_ref)

                  def sanitize_brand(self, brand):
                      """Sanitize brand name for URL"""
                      return brand.lower().replace(' ', '').replace('casino', '')

                  def generate_site(self, domain, brand):
                      """Generate site for domain and brand"""
                      try:
                          brand_safe = self.sanitize_brand(brand)
                          fqdn = f"{brand_safe}casino.{domain}"
                          site_dir = Path(self.output_dir) / fqdn
                          site_dir.mkdir(parents=True, exist_ok=True)
                          
                          context = {
                              'BRAND': brand,
                              'DOMAIN': domain,
                              'MAIN_FQDN': fqdn,
                              'MIRROR_FQDN': fqdn,
                              'KEYWORD': f'{brand.lower()} online',
                              'REF_LINK': self.get_ref_link(brand),
                              'YEAR': str(datetime.now().year),
                          }
                          
                          template = self.env.get_template('index.html.tpl')
                          
                          # Generate pages
                          pages = ['index.html', 'register/index.html', 'bonus/index.html', 
                                 'reviews/index.html', 'withdrawal/index.html']
                          
                          for page in pages:
                              html = template.render(context)
                              path = site_dir / page
                              path.parent.mkdir(parents=True, exist_ok=True)
                              path.write_text(html, encoding='utf-8')
                          
                          # robots.txt
                          (site_dir / 'robots.txt').write_text(
                              f"User-agent: *\nAllow: /\nSitemap: https://{fqdn}/sitemap.xml\n"
                          )
                          
                          # sitemap.xml
                          sitemap = f'''<?xml version="1.0" encoding="UTF-8"?>
              <urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
                  <url><loc>https://{fqdn}/</loc><priority>1.0</priority></url>
                  <url><loc>https://{fqdn}/register/</loc><priority>0.9</priority></url>
                  <url><loc>https://{fqdn}/bonus/</loc><priority>0.8</priority></url>
                  <url><loc>https://{fqdn}/reviews/</loc><priority>0.7</priority></url>
                  <url><loc>https://{fqdn}/withdrawal/</loc><priority>0.7</priority></url>
              </urlset>'''
                          (site_dir / 'sitemap.xml').write_text(sitemap, encoding='utf-8')
                          
                          self.generated += 1
                          print(f"âœ… Generated: {fqdn}")
                          return True
                      except Exception as e:
                          print(f"âŒ Error generating {brand}@{domain}: {e}")
                          return False

                  def run(self):
                      """Generate all sites"""
                      print(f"ğŸ° Starting generation for {len(self.domains)} domains Ã— {len(self.brands)} brands...")
                      for domain in self.domains:
                          for brand in self.brands:
                              self.generate_site(domain, brand)
                      print(f"\nâœ… Total generated: {self.generated} sites")
                      return True

              # Main
              domains = {{ domains_list | tojson }}
              brands = {{ brands_list | tojson }}
              refs = {{ refs_dict | tojson }}
              default_ref = {{ default_ref | tojson }}
              
              os.chdir("{{ work_dir }}")
              gen = CasinoGenerator(domains, brands, refs, "{{ output_dir }}", "{{ templates_dir }}", default_ref)
              success = gen.run()
              sys.exit(0 if success else 1)
            dest: "{{ work_dir }}/generate_sites_v2.py"
            mode: '0755'

        - name: "Run generation script"
          command: "python3 {{ work_dir }}/generate_sites_v2.py"
          register: generation_result
          changed_when: true

        - name: "Display generation output"
          debug:
            msg: "{{ generation_result.stdout }}"

    - name: "ğŸ“Š STEP 4: Verify Generation"
      block:
        - name: "Count generated files"
          find:
            path: "{{ work_dir }}/{{ output_dir }}"
            name: "index.html"
            recurse: yes
          register: html_files

        - name: "Count generated domains"
          find:
            path: "{{ work_dir }}/{{ output_dir }}"
            file_type: directory
            depth: 1
          register: domain_dirs

        - name: "Calculate total size"
          shell: "du -sh {{ work_dir }}/{{ output_dir }} | cut -f1"
          register: output_size
          changed_when: false

        - name: "Display verification"
          debug:
            msg: |
              âœ… Generation Results:
              ğŸ“ Domains: {{ domain_dirs.matched }}
              ğŸ“„ Pages: {{ html_files.matched }}
              ğŸ“¦ Size: {{ output_size.stdout }}
              ğŸ¯ Ready for deployment

    - name: "ğŸ”„ STEP 5: Git Commit & Push"
      block:
        - name: "Git add all"
          shell: "cd {{ work_dir }} && git add -A"
          register: git_add_result
          changed_when: true

        - name: "Git commit"
          shell: |
            cd {{ work_dir }}
            git commit -m "Generated {{ domain_dirs.matched }} casino sites - {{ ansible_date_time.iso8601 }}" 2>&1 || echo "Nothing to commit"
          register: git_commit_result
          changed_when: "'create mode' in git_commit_result.stdout or 'insertion' in git_commit_result.stdout"

        - name: "Git push"
          shell: "cd {{ work_dir }} && git push origin master 2>&1 || true"
          register: git_push_result
          changed_when: false

        - name: "Display git results"
          debug:
            msg: |
              âœ… Git: {{ 'Pushed' if 'master -> master' in git_push_result.stdout else 'Committed locally' }}

  post_tasks:
    - name: "ğŸ‰ Generation Complete"
      debug:
        msg: |
          â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
          â•‘  âœ… GENERATION COMPLETED!                             â•‘
          â•‘                                                        â•‘
          â•‘  ğŸ“Š Sites: {{ domain_dirs.matched }}
          â•‘  ğŸ“„ Pages: {{ html_files.matched }}
          â•‘  ğŸ“¦ Size: {{ output_size.stdout }}
          â•‘  ğŸ“ Output: {{ work_dir }}/{{ output_dir }}
          â•‘  ğŸ”— Git: Pushed
          â•‘                                                        â•‘
          â•‘  ğŸš€ Ready for production deployment!                  â•‘
          â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
