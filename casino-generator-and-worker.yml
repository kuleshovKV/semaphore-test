---
- name: "ğŸ° CASINO SITES GENERATOR & CLOUDFLARE WORKER DEPLOY"
  hosts: all
  become: true
  gather_facts: yes

  vars:
    generator_dir: "/var/www/casino_generator"
    worker_name: "casino-cloaking-worker"
    cf_account_id: "{{ cloudflare_account_id }}"
    cf_api_token: "{{ cloudflare_api_token }}"

  pre_tasks:
    - name: "âœ… Show playbook info"
      debug:
        msg: |
          ğŸ° CASINO GENERATOR + CLOUDFLARE WORKER
          âœ… Generate casino sites (HTML, pages, favicon)
          âœ… Deploy to Cloudflare Worker (YandexBot cloaking)
          âœ… Referral redirects for search users
          âœ… Block others (403)

  tasks:
    # ============ SITE GENERATION SECTION ============
    
    - name: "ğŸ“¦ Install ImageMagick for favicon generation"
      apt:
        name: imagemagick-6.q16
        state: present
        update_cache: yes

    - name: "ğŸ“ Ensure generator dir exists"
      file:
        path: "{{ generator_dir }}"
        state: directory
        mode: '0755'

    - name: "ğŸ“¥ Clone/update git repository"
      git:
        repo: "https://github.com/kuleshovKV/semaphore-test.git"
        dest: "{{ generator_dir }}"
        version: master
        force: yes

    - name: "ğŸ”§ Make generate_sites.sh executable"
      file:
        path: "{{ generator_dir }}/generate_sites.sh"
        mode: '0755'
        state: file

    - name: "ğŸš€ Run generation script"
      shell: "cd {{ generator_dir }} && ./generate_sites.sh"
      register: generation_output
      timeout: 300

    - name: "âœ… Show generation result"
      debug:
        msg: "{{ generation_output.stdout }}"

    - name: "ğŸ“Š Count generated files"
      shell: "find {{ generator_dir }}/output -type f | wc -l"
      register: file_count

    - debug:
        msg: "Generated {{ file_count.stdout }} files"

    # ============ CLOUDFLARE WORKER SECTION ============

    - name: "ğŸ”µ Read Cloudflare Worker script"
      slurp:
        src: "{{ generator_dir }}/cloudflare-worker-cloaking-advanced.js"
      register: worker_code

    - name: "ğŸš€ Deploy Cloudflare Worker"
      uri:
        url: "https://api.cloudflare.com/client/v4/accounts/{{ cf_account_id }}/workers/scripts/{{ worker_name }}"
        method: PUT
        headers:
          Authorization: "Bearer {{ cf_api_token }}"
          Content-Type: "application/javascript"
        body: "{{ worker_code['content'] | b64decode }}"
        status_code: 200, 201
      register: worker_deploy
      ignore_errors: yes

    - name: "âœ… Worker deploy result"
      debug:
        msg: "{{ worker_deploy.json | default(worker_deploy.msg) }}"

    - name: "ğŸ”— Create Cloudflare Route for Worker"
      uri:
        url: "https://api.cloudflare.com/client/v4/accounts/{{ cf_account_id }}/workers/routes"
        method: POST
        headers:
          Authorization: "Bearer {{ cf_api_token }}"
          Content-Type: "application/json"
        body_format: json
        body:
          pattern: "*.{{ casino_domain }}/*"
          script: "{{ worker_name }}"
        status_code: 200, 201
      register: route_result
      ignore_errors: yes

    - name: "âœ… Route binding result"
      debug:
        msg: "{{ route_result.json | default(route_result.msg) }}"

  post_tasks:
    - name: "ğŸ“‹ SUMMARY"
      debug:
        msg: |
          
          âœ… ========================================
          âœ… CASINO GENERATOR + WORKER DEPLOYED
          âœ… ========================================
          
          ğŸ“Š GENERATION STATS:
            - Generated files: {{ file_count.stdout }}
            - Generator dir: {{ generator_dir }}
            - Source: https://github.com/kuleshovKV/semaphore-test.git
          
          ğŸ”µ CLOUDFLARE WORKER:
            - Name: {{ worker_name }}
            - Account ID: {{ cf_account_id }}
            - Status: Deployed
          
          ğŸ¯ ROUTING RULES:
            1. âœ… YandexBot (200 OK):
               â†’ Proxies to origin server
               â†’ Serves generated site content
               â†’ Cache: 1 hour
               â†’ Full HTML + pages + dynamic favicon
          
            2. ğŸ”„ Search engine users (301 redirect):
               - kilogram.* â†’ https://kgpar.com/refs/share?refId=subkilo
               - sykaaa.* â†’ https://s-way-q.com/?source=sub_sykaaa
               - default â†’ https://kgpar.com/refs/share?refId=cross_1
          
            3. ğŸš« Others (403 Forbidden):
               â†’ Access denied for direct traffic
          
          ğŸŒ Pattern: {{ casino_domain }}/*
          ğŸ” Hosted on: Cloudflare Edge
          ğŸ“ Regions: Global CDN
          
          âœ… Monitor logs: Cloudflare Dashboard â†’ Workers
