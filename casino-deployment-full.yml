---
- name: "ðŸŽ° CASINO DEPLOYMENT"
  hosts: all
  become: true
  gather_facts: yes
  
  vars:
    generator_dir: "/var/www/casino_generator"
    log_dir: "/var/log/casino-deployment"
    
  tasks:
    - name: "ðŸ“¦ Install ImageMagick"
      apt:
        name: imagemagick-6.q16
        state: present
        update_cache: yes
      ignore_errors: yes

    - name: "ðŸ“ Create directories"
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - "{{ generator_dir }}"
        - "{{ log_dir }}"

    - name: "ðŸ“¥ Clone repository"
      git:
        repo: "https://github.com/kuleshovKV/semaphore-test.git"
        dest: "{{ generator_dir }}"
        version: master
        force: yes

    - name: "ðŸš€ Run generation script"
      shell: |
        cd {{ generator_dir }}
        if [ -f generate_sites.sh ]; then
          bash generate_sites.sh
        fi
      ignore_errors: yes

    - name: "ðŸ“– Read domains.csv"
      shell: |
        if [ -f {{ generator_dir }}/domains.csv ]; then
          cat {{ generator_dir }}/domains.csv
        else
          echo ""
        fi
      register: domains_raw

    - name: "Parse domains"
      set_fact:
        domains_list: "{{ domains_raw.stdout_lines | reject('match', '^$') | list }}"

    - name: "Show domains count"
      debug:
        msg: "Found {{ domains_list | length }} domains"

    - name: "â˜ï¸ Check Cloudflare zones"
      shell: |
        curl -s -X GET "https://api.cloudflare.com/client/v4/zones?name={{ item }}" \
          -H "X-Auth-Email: {{ cf_email }}" \
          -H "X-Auth-Key: {{ cf_api_key }}" \
          -H "Content-Type: application/json" | \
          python3 -c "import sys, json; d=json.load(sys.stdin); print(d['result'][0]['id'] if d.get('result') else '')"
      register: zone_ids_raw
      loop: "{{ domains_list }}"
      delay: 0.5
      ignore_errors: yes

    - name: "Extract zone IDs"
      set_fact:
        zone_ids: "{{ zone_ids_raw.results | map(attribute='stdout') | select('string') | reject('match', '^$') | list }}"

    - name: "Show zone IDs"
      debug:
        msg: "Zone IDs: {{ zone_ids }}"

    - name: "ðŸŒ Create A records"
      shell: |
        curl -s -X POST "https://api.cloudflare.com/client/v4/zones/{{ item.1 }}/dns_records" \
          -H "X-Auth-Email: {{ cf_email }}" \
          -H "X-Auth-Key: {{ cf_api_key }}" \
          -H "Content-Type: application/json" \
          -d '{"type":"A","name":"{{ item.0 }}","content":"{{ ansible_default_ipv4.address }}","ttl":1,"proxied":true}'
      loop: "{{ domains_list | zip(zone_ids) | list }}"
      delay: 0.5
      ignore_errors: yes

    - name: "ðŸŒ Create CNAME records"
      shell: |
        curl -s -X POST "https://api.cloudflare.com/client/v4/zones/{{ item.1 }}/dns_records" \
          -H "X-Auth-Email: {{ cf_email }}" \
          -H "X-Auth-Key: {{ cf_api_key }}" \
          -H "Content-Type: application/json" \
          -d '{"type":"CNAME","name":"www.{{ item.0 }}","content":"{{ item.0 }}","ttl":1,"proxied":true}'
      loop: "{{ domains_list | zip(zone_ids) | list }}"
      delay: 0.5
      ignore_errors: yes

    - name: "ðŸ”‘ Get nameservers"
      shell: |
        curl -s -X GET "https://api.cloudflare.com/client/v4/zones/{{ item }}" \
          -H "X-Auth-Email: {{ cf_email }}" \
          -H "X-Auth-Key: {{ cf_api_key }}" \
          -H "Content-Type: application/json" | \
          python3 -c "import sys, json; d=json.load(sys.stdin); print(','.join(d['result']['name_servers']) if d.get('result') else '')"
      register: nameservers_raw
      loop: "{{ zone_ids }}"
      delay: 0.5
      ignore_errors: yes

    - name: "ðŸ’¾ Create nameservers CSV"
      shell: |
        cat > {{ log_dir }}/NAMESERVERS_BULK_{{ inventory_hostname }}.csv << 'CSVEOF'
        Domain,Nameserver1,Nameserver2
        {% for i in range(domains_list | length) %}
        {% set ns = nameservers_raw.results[i].stdout.split(',') if i < nameservers_raw.results | length else [] %}
        {{ domains_list[i] }},{{ ns[0] if ns | length > 0 else '' }},{{ ns[1] if ns | length > 1 else '' }}
        {% endfor %}
        CSVEOF
      args:
        executable: /bin/bash
      ignore_errors: yes

    - name: "ðŸ’¾ Create nameservers TXT"
      shell: |
        cat > {{ log_dir }}/NAMESERVERS_{{ inventory_hostname }}.txt << 'TXTEOF'
        # Cloudflare Nameservers for {{ inventory_hostname }}
        # Generated: {{ ansible_date_time.iso8601 }}
        
        {% for i in range(domains_list | length) %}
        Domain: {{ domains_list[i] }}
        {% set ns = nameservers_raw.results[i].stdout.split(',') if i < nameservers_raw.results | length else [] %}
        {% for n in ns %}
        {{ n }}
        {% endfor %}
        
        {% endfor %}
        TXTEOF
      args:
        executable: /bin/bash
      ignore_errors: yes

    - name: "ðŸ“¥ Download CSV file"
      fetch:
        src: "{{ log_dir }}/NAMESERVERS_BULK_{{ inventory_hostname }}.csv"
        dest: "./fetched/{{ inventory_hostname }}/"
        flat: yes
      ignore_errors: yes

    - name: "ðŸ“¥ Download TXT file"
      fetch:
        src: "{{ log_dir }}/NAMESERVERS_{{ inventory_hostname }}.txt"
        dest: "./fetched/{{ inventory_hostname }}/"
        flat: yes
      ignore_errors: yes

    - name: "âœ… Deployment complete"
      debug:
        msg: |
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
          âœ… DEPLOYMENT COMPLETED!
          
          Host: {{ inventory_hostname }}
          Domains: {{ domains_list | length }}
          Zones: {{ zone_ids | length }}
          
          Files saved in: {{ log_dir }}/
          Downloaded to: ./fetched/{{ inventory_hostname }}/
          
          CSV: NAMESERVERS_BULK_{{ inventory_hostname }}.csv
          TXT: NAMESERVERS_{{ inventory_hostname }}.txt
          â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
